<!DOCTYPE html>
<html lang="en">
<head>
  <% layout = false %>
  <meta charset="UTF-8">
  <title>Post by <%= currentUser %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #fafafa; font-family: Arial, sans-serif; padding-bottom: 70px; }
    .post-container { max-width: 600px; margin: 30px auto; background: white; border: 1px solid #ddd; border-radius: 10px; }
    .post-header, .post-footer { padding: 10px; display: flex; align-items: center; }
    .post-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .post-image, .post-video { width: 100%; height: auto; border-bottom: 1px solid #eee; }
    .btn-like, .btn-comment, .btn-bookmark { cursor: pointer; font-size: 20px; margin-right: 10px; }
    .stats { font-size: 14px; margin: 10px; font-weight: bold; }

    .save-btn {
      background-color: #eee;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
    }

    .save-btn.saved {
      background-color: #28a745;
      color: white;
    }

    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
      z-index: 9999;
    }

    .toast-notification.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>
<div class="post-container">
  <div class="post-header">
    <a href="/users/<%= currentUser %>">
      <img src="<%= post.user.avatar || '/default-avatar.png' %>" alt="avatar">
    </a>
    <strong><%= post.user.username%></strong>
  </div>

  <% if (post.mediaType === 'image') { %>
    <img src="<%= post.media %>" class="post-image" alt="Post Image">
  <% } else if (post.mediaType === 'video') { %>
    <video class="post-video" controls>
      <source src="<%= post.media %>" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  <% } %>

  <div class="post-footer">
    <div class="d-flex align-items-center">
      <i class="bi <%= post.likes.includes(currentUser?._id) ? 'bi-heart-fill text-danger' : 'bi-heart' %> btn-like" title="Like"></i>
 <a href="#comment-btn" title="Comment" role="button" class="btn-comment">
  <i class="bi bi-chat"></i>
</a>
      <% if (currentUser) { %>
     <!-- 
        <i class="bi <%= currentUser.bookmarks.includes(post._id) ? 'bi-bookmark-fill text-primary' : 'bi-bookmark' %> btn-bookmark" title="Bookmark"></i>
      Scripts -->
        <% } %>

      <i class="bi bi-share btn-share" style="cursor: pointer;" title="Share"></i>
    </div>
  </div>

  <div id="share-options" class="p-3" style="display: none;">
    <button class="btn btn-outline-secondary btn-sm" id="copy-link">ðŸ“‹ Copy Link</button>
    <a class="btn btn-outline-primary btn-sm" target="_blank" id="whatsapp-share">WhatsApp</a>
    <a class="btn btn-outline-info btn-sm" target="_blank" id="telegram-share">Telegram</a>
    <a class="btn btn-outline-success btn-sm" target="_blank" id="facebook-share">Facebook</a>
  </div>

  <span><%= post.shares || 0 %> Shares</span>

  <div class="stats">
    <span><%= post.likes.length %> Likes</span> |
    <span><%= post.comments.length %> Comments</span>
    <form class="save-post-form" data-post-id="<%= post._id %>">
      <% if (currentUser && currentUser.savedPosts && currentUser.savedPosts.includes(post._id.toString())) { %>
        <button type="submit" class="save-btn saved">ðŸ—‘ Remove Saved</button>
      <% } else { %>
        <button type="submit" class="save-btn">ðŸ’¾ Save</button>
      <% } %>
    </form>
  </div>

  <div class="px-3 pb-3">
    <strong><%= post.user.username %></strong> <%= post.caption %>
  </div>

  <div class="px-3 pb-3" id="comment-btn">
    <% post.comments.forEach(c => { %>
      <p><strong><%= c.user.username %>:</strong> <%= c.text %></p>
    <% }) %>
  </div>

  <% if (currentUser) { %>
    <form class="px-3 pb-3" id="comment-form">
      <div class="input-group">
        <input type="text" name="text" class="form-control" placeholder="Add a comment..." required>
        <button class="btn btn-primary" type="submit">Post</button>
      </div>
    </form>
  <% } else { %>
    <p class="text-center text-muted pb-3">Login to comment.</p>
  <% } %>

  <% if (currentUser && currentUser._id.toString() === post.user._id.toString()) { %>
    <canvas id="analytics-chart" height="150"></canvas>
  <% } %>
</div>

<!-- Toast for Copy Link -->
<div id="copy-toast" class="toast-notification">âœ… Link copied to clipboard!</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  <% if (currentUser) { %>
    socket.emit('register', '<%= currentUser._id %>');
    socket.on('newNotification', data => alert(data.message));
  <% } %>

  // Like
  document.querySelector('.btn-like').addEventListener('click', async () => {
    const res = await fetch('/posts/like/<%= post._id %>', { method: 'POST' });
    if (res.ok) location.reload();
  });

  // Bookmark
  const bookmarkBtn = document.querySelector('.btn-bookmark');
  if (bookmarkBtn) {
    bookmarkBtn.addEventListener('click', async () => {
      await fetch(`/posts/bookmark/<%= post._id %>`, { method: 'POST' });
      location.reload();
    });
  }

  // Comment
  const commentForm = document.getElementById('comment-form');
  if (commentForm) {
    commentForm.addEventListener('submit', async e => {
      e.preventDefault();
      const textInput = commentForm.querySelector('input[name="text"]');
      const text = textInput.value.trim();
      if (!text) return;

      const res = await fetch(`/posts/comment/<%= post._id %>`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (res.ok) location.reload();
    });
  }

  // Save/Unsave
  document.querySelectorAll('.save-post-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const postId = form.getAttribute('data-post-id');
      const button = form.querySelector('button');
      const isSaved = button.classList.contains('saved');

      const res = await fetch(`/posts/${isSaved ? 'unsavePost' : 'savePost'}/${postId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

const result = await res.json();
if (res.ok) {
  if (isSaved) {
    button.classList.remove('saved');
    button.textContent = 'ðŸ’¾ Save';
  } else {
    button.classList.add('saved');
    button.textContent = 'ðŸ—‘ Remove Saved';
  }
}
    });
  });

  // Share Toggle
  document.querySelector('.btn-share').addEventListener('click', () => {
    const shareOptions = document.getElementById('share-options');
    shareOptions.style.display = shareOptions.style.display === 'none' ? 'block' : 'none';
  });

  // Copy link with toast
  document.getElementById('copy-link').addEventListener('click', () => {
    const toast = document.getElementById('copy-toast');
    navigator.clipboard.writeText(window.location.href).then(() => {
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    });
  });

  // Social Sharing
  document.getElementById('whatsapp-share').href = `https://wa.me/?text=${encodeURIComponent(window.location.href)}`;
  document.getElementById('telegram-share').href = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}`;
  document.getElementById('facebook-share').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`;

  // Analytics Chart
  <% if (currentUser && currentUser._id.toString() === post.user._id.toString()) { %>
    const ctx = document.getElementById('analytics-chart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Likes', 'Comments'],
        datasets: [{
          data: [<%= post.likes.length %>, <%= post.comments.length %>],
          backgroundColor: ['#dc3545', '#0d6efd']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  <% } %>
</script>
</body>
</html>
